#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DIR="$SCRIPT_DIR/dev/migrations"
mkdir -p "$DIR"

if [ $# -lt 1 ]; then
  echo "Usage: make-migration <description words>"
  exit 1
fi

slug="$*"
slug=$(echo "$slug" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/_/g' | sed -E 's/^_|_$//g')
ts=$(date +%Y%m%d_%H%M%S)
filename="${ts}_${slug}.sql"
path="$DIR/$filename"

cat > "$path" <<EOF
-- Migration: $filename
-- Created: $(date '+%Y-%m-%d %H:%M:%S')
-- Description: $*
START TRANSACTION;

-- write SQL below this line

COMMIT;
EOF

echo "Created $path"