name: Palermo deploy script

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup log file
      - name: Setup log file
        run: |
          mkdir -p $GITHUB_WORKSPACE/logs
          echo "Deployment started at $(date '+%Y-%m-%d %H:%M:%S')" > $GITHUB_WORKSPACE/logs/deploy.log

      # 3. Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, pdo_mysql
          coverage: none

      # 4. Install PHP dependencies
      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader 2>&1 | tee -a $GITHUB_WORKSPACE/logs/deploy.log

      # 5. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 6. Install NPM dependencies
      - name: Install NPM dependencies
        run: npm ci 2>&1 | tee -a $GITHUB_WORKSPACE/logs/deploy.log

      # 7. Build frontend assets
      - name: Build frontend assets
        run: npm run build 2>&1 | tee -a $GITHUB_WORKSPACE/logs/deploy.log

      # 8. Set environment configuration files
      - name: Set environment configuration files
        run: |
          echo "Selecting environment files..." | tee -a $GITHUB_WORKSPACE/logs/deploy.log
          cp .htaccess.live .htaccess
          cp include/config.live.php include/config.php
          echo "Environment config applied." | tee -a $GITHUB_WORKSPACE/logs/deploy.log

      # 9. Deploy code via rsync
      - name: Deploy code via rsync
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avzr --delete --no-perms --no-owner --no-group --omit-dir-times --exclude='.git*' --exclude='.github' --exclude='node_modules' --exclude='uploads/'
          path: ./
          remote_path: /var/www/kursova.balikgstudio.eu/
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}
          remote_port: 2222

      
       # 9.5 Apply SQL migrations from dev/migrations on remote host
      - name: Apply SQL migrations from dev/migrations
        if: github.event_name == 'release'
        run: |
          echo "${{ secrets.SERVER_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          ssh -i private_key.pem -p 2222 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -euo pipefail
            cd /var/www/kursova.balikgstudio.eu/ || exit 1

            MIGDIR="dev/migrations"

            # skip if dir missing or empty
            if [ ! -d "$MIGDIR" ] || [ -z "$(ls -A "$MIGDIR" 2>/dev/null)" ]; then
              echo "No migrations directory or no .sql files found in ($MIGDIR), skipping."
              exit 0
            fi

            DB_HOST="${{ secrets.DB_HOST }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASS="${{ secrets.DB_PASSWORD }}"
            DB_NAME="${{ secrets.DB_NAME }}"

            if [ -z "$DB_HOST" ] || [ -z "$DB_USER" ] || [ -z "$DB_NAME" ]; then
              echo "DB credentials missing (DB_HOST/DB_USER/DB_NAME). Skipping migrations."
              exit 0
            fi

            echo "Ensuring migrations_applied table exists..."
            mysql -h "$DB_HOST" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "CREATE TABLE IF NOT EXISTS migrations_applied (id INT AUTO_INCREMENT PRIMARY KEY, filename VARCHAR(255) NOT NULL UNIQUE, applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);"

            echo "Applying SQL files from $MIGDIR (lexicographic order)..."
            for f in "$MIGDIR"/*.sql; do
              [ -e "$f" ] || continue
              fname=$(basename "$f")
              already=$(mysql -h "$DB_HOST" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -sN -e "SELECT filename FROM migrations_applied WHERE filename='${fname}' LIMIT 1;" || true)
              if [ -n "$already" ]; then
                echo "Skipping ${fname} (already applied)"
                continue
              fi

              echo "Applying ${fname}..."
              if mysql -h "$DB_HOST" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$f"; then
                mysql -h "$DB_HOST" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "INSERT INTO migrations_applied (filename) VALUES ('${fname}');"
                echo "Applied ${fname}"
              else
                echo "Migration failed: ${fname}"
                exit 1
              fi
            done

            echo "Migrations complete."
          EOF
          2>&1 | tee -a $GITHUB_WORKSPACE/logs/deploy.log

      # 10. Remote setup: Ensure uploads dir exists, fix permissions, update version
      - name: Permissions & version update on remote host
        if: github.event_name == 'release'
        run: |
          echo "${{ secrets.SERVER_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          ssh -i private_key.pem -p 2222 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd /var/www/kursova.balikgstudio.eu/

            echo 'Ensuring uploads/ exists...'
            sudo mkdir -p uploads
            sudo chown -R www-data:www-data uploads
            sudo chmod -R 775 uploads

            echo 'Updating .version.txt...'
            echo '${{ github.event.release.tag_name }} - $(date "+%Y-%m-%d %H:%M:%S")' | sudo tee .version.txt > /dev/null
          EOF
          2>&1 | tee -a $GITHUB_WORKSPACE/logs/deploy.log

      # 11. Optional: Test database connection
      - name: Test DB connection
        run: |
          echo "Testing database connection..."
          php -r "
          \$mysqli = new mysqli('${{ secrets.DB_HOST }}', '${{ secrets.DB_USER }}', '${{ secrets.DB_PASSWORD }}', '${{ secrets.DB_NAME }}');
          if (\$mysqli->connect_errno) { echo 'DB connection failed: '.\$mysqli->connect_error; exit(1); }
          echo 'DB connection successful';
          \$mysqli->close();
          " 2>&1 | tee -a $GITHUB_WORKSPACE/logs/deploy.log
